<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авторизация и загрузка видео в ВКонтакте</title>
</head>
<body>
    <h1>Авторизация через ВКонтакте</h1>
    <div id="auth-container">
        <!-- Подключение VKID SDK -->
        <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
        <script type="text/javascript">
            if ('VKIDSDK' in window) {
                const VKID = window.VKIDSDK;

                // Инициализация VKID SDK
                VKID.Config.init({
                    app: 52966496, // Замените на ваш реальный ID приложения из настроек
                    redirectUrl: 'https://fhyh246.github.io/anegdot/', // Адрес, где размещено приложение
                    responseMode: VKID.ConfigResponseMode.Callback,
                    source: VKID.ConfigSource.LOWCODE,
                    scope: 'video,offline,wall', // Запрашиваемые доступы
                });

                // Создание кнопки One Tap
                const oneTap = new VKID.OneTap();

                oneTap.render({
                    container: document.getElementById('auth-container'),
                    scheme: 'dark', // Тема кнопки ('dark' или 'light')
                    showAlternativeLogin: true // Показывать альтернативные способы входа
                })
                .on(VKID.WidgetEvents.ERROR, vkidOnError)
                .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                    const code = payload.code;
                    const deviceId = payload.device_id;

                    // Обмен кода на токен доступа
                    VKID.Auth.exchangeCode(code, deviceId)
                        .then(vkidOnSuccess)
                        .catch(vkidOnError);
                });

                // Обработка успешной авторизации
                function vkidOnSuccess(data) {
                    console.log("Успешная авторизация:", data);
                    alert("Авторизация прошла успешно! Токен: " + data.access_token);
                }

                // Обработка ошибок
                function vkidOnError(error) {
                    console.error("Ошибка авторизации:", error);
                    alert("Произошла ошибка при авторизации.");
                }
            }
        </script>
    </div>

    <hr>

    <h1>Загрузка видео в группу ВКонтакте</h1>
    <label for="groupId">ID группы ВКонтакте:</label>
    <input type="text" id="groupId" placeholder="Введите ID группы">
    <label for="youtubeLink">Ссылка на YouTube-видео:</label>
    <input type="text" id="youtubeLink" placeholder="Вставьте ссылку на видео">
    <button id="uploadButton">Загрузить видео</button>
    <div id="status"></div>

    <script>
        const serviceToken = "ecc5b84cecc5b84cecc5b84cc0efed8c2ceecc5ecc5b84c8b511ddeeea5a3e19c4dd83b";

        document.getElementById('uploadButton').addEventListener('click', async () => {
            const groupId = document.getElementById('groupId').value.trim();
            const youtubeLink = document.getElementById('youtubeLink').value.trim();
            const status = document.getElementById('status');

            if (!groupId || !youtubeLink) {
                status.textContent = "Пожалуйста, заполните все поля.";
                return;
            }

            try {
                // 1. Получить сервер для загрузки видео
                const uploadServerResponse = await fetch(`https://api.vk.com/method/video.save?group_id=${groupId}&link=${encodeURIComponent(youtubeLink)}&access_token=${serviceToken}&v=5.131`);
                const uploadServerData = await uploadServerResponse.json();

                if (uploadServerData.error) {
                    throw new Error(`Ошибка API ВКонтакте: ${uploadServerData.error.error_msg}`);
                }

                const uploadUrl = uploadServerData.response.upload_url;

                // 2. Загрузить видео на полученный сервер
                const videoUploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                });
                const videoUploadData = await videoUploadResponse.json();

                if (videoUploadData.error) {
                    throw new Error(`Ошибка при загрузке видео: ${videoUploadData.error.error_msg}`);
                }

                status.textContent = "Видео успешно загружено в группу ВКонтакте!";
            } catch (error) {
                console.error(error);
                status.textContent = `Произошла ошибка: ${error.message}`;
            }
        });
    </script>
</body>
</html>