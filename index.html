<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Сканер QR-чеков</title>
    <!-- Подключение библиотеки html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>Касса</h1>
    <div>
        <h2>Безнал</h2>
        <ul id="bezNalList"></ul>
    </div>
    <div>
        <h2>Наличные</h2>
        <ul id="nalList"></ul>
    </div>

    <div id="qr-reader" style="width: 500px;"></div>
    <div id="qr-reader-results"></div>

    <script>
        // Функция для обработки и добавления данных из QR-кода
        function processQRData(data) {
            const lines = data.trim().split('\n');
            const bezNalList = document.getElementById('bezNalList');
            const nalList = document.getElementById('nalList');

            lines.forEach(line => {
                const timeAdjusted = adjustTime(line);
                const listItem = document.createElement('li');
                listItem.textContent = timeAdjusted;

                if (line.includes("Наличные")) {
                    nalList.appendChild(listItem);
                } else {
                    bezNalList.appendChild(listItem);
                }
            });
        }

        // Функция корректировки времени на один час назад
        function adjustTime(line) {
            const timePattern = /(\d{1,2}) (\d{2})$/;
            const match = line.match(timePattern);

            if (match) {
                let hours = parseInt(match[1], 10);
                const minutes = match[2];
                
                // Уменьшить время на один час
                hours = (hours - 1 + 24) % 24;
                return line.replace(timePattern, `${hours} ${minutes}`);
            }
            return line;
        }

        // Инициализация html5-qrcode для сканирования
        function onScanSuccess(decodedText, decodedResult) {
            // Выводим результат для проверки
            document.getElementById('qr-reader-results').innerText = `Данные из QR: ${decodedText}`;
            
            // Обрабатываем данные
            processQRData(decodedText);
        }

        function onScanFailure(error) {
            // Ошибки сканирования можно игнорировать или выводить для отладки
            console.warn(`Ошибка сканирования: ${error}`);
        }

        // Настройка QR-сканера с вызовами при успехе или ошибке
        const html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: 250 };

        // Запускаем сканирование с использованием камеры
        html5QrCode.start(
            { facingMode: "environment" }, // Использует заднюю камеру
            config,
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            console.error(`Ошибка при запуске сканера: ${err}`);
        });
    </script>
</body>
</html>