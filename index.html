<script>
  const grid = document.getElementById('grid');
  const status = document.getElementById('status');
  const peerList = document.getElementById('peerList');
  const connectButton = document.getElementById('connectButton');

  let localConnection, dataChannel;
  let isMyTurn = false;
  let currentPlayer = "X";
  let connectedPeer = null;

  const socket = new WebSocket('ws://localhost:8080'); // Подключение к серверу

  socket.onopen = () => {
    const name = prompt("Введите своё имя:");
    socket.send(JSON.stringify({ type: "register", name }));
  };

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "players") {
      updatePlayerList(data.players);
    }

    if (data.type === "signal" && data.target === localName) {
      handleSignal(data);
    }
  };

  function updatePlayerList(players) {
    peerList.innerHTML = players
      .filter((player) => player !== localName)
      .map((player) => `<option value="${player}">${player}</option>`)
      .join("");
  }

  connectButton.addEventListener("click", () => {
    const peer = peerList.value;
    if (peer) {
      startConnection(peer);
    }
  });

  function startConnection(peer) {
    localConnection = new RTCPeerConnection();
    dataChannel = localConnection.createDataChannel("game");
    connectedPeer = peer;

    dataChannel.onopen = () => {
      isMyTurn = true;
      status.textContent = "Вы подключены! Ваш ход.";
    };

    dataChannel.onmessage = (event) => {
      const { index, player } = JSON.parse(event.data);
      makeMove(index, player);
    };

    localConnection.onicecandidate = (event) => {
      if (event.candidate) {
        socket.send(JSON.stringify({
          type: "signal",
          target: peer,
          candidate: event.candidate,
        }));
      }
    };

    localConnection.createOffer().then((offer) => {
      localConnection.setLocalDescription(offer);
      socket.send(JSON.stringify({
        type: "signal",
        target: peer,
        offer,
      }));
    });
  }

  function handleSignal(data) {
    if (data.offer) {
      localConnection = new RTCPeerConnection();
      localConnection.ondatachannel = (event) => {
        dataChannel = event.channel;

        dataChannel.onopen = () => {
          isMyTurn = false;
          status.textContent = "Вы подключены! Ход соперника.";
        };

        dataChannel.onmessage = (event) => {
          const { index, player } = JSON.parse(event.data);
          makeMove(index, player);
        };
      };

      localConnection.onicecandidate = (event) => {
        if (event.candidate) {
          socket.send(JSON.stringify({
            type: "signal",
            target: data.name,
            candidate: event.candidate,
          }));
        }
      };

      localConnection.setRemoteDescription(data.offer);
      localConnection.createAnswer().then((answer) => {
        localConnection.setLocalDescription(answer);
        socket.send(JSON.stringify({
          type: "signal",
          target: data.name,
          answer,
        }));
      });
    }

    if (data.answer) {
      localConnection.setRemoteDescription(data.answer);
    }

    if (data.candidate) {
      localConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    }
  }

  function makeMove(index, player) {
    const cell = grid.children[index];
    if (!cell.classList.contains('taken')) {
      cell.textContent = player;
      cell.classList.add('taken');

      if (checkWin(player)) {
        status.textContent = `Победил ${player}!`;
        return;
      }

      currentPlayer = player === "X" ? "O" : "X";
      isMyTurn = !isMyTurn;
      status.textContent = isMyTurn ? "Ваш ход." : "Ход соперника.";
    }
  }

  function checkWin(player) {
    const winningCombinations = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8],
      [0, 3, 6], [1, 4, 7], [2, 5, 8],
      [0, 4, 8], [2, 4, 6]
    ];
    return winningCombinations.some((combo) =>
      combo.every((index) => grid.children[index].textContent === player)
    );
  }
</script>