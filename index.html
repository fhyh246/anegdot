<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка ссылок</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .working { color: green; }
        .not-working { color: red; }
        #results, #workingLinks {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            width: 100%;
            max-width: 600px;
        }
        .container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
        }
        h2 {
            text-align: center;
        }
        button {
            margin-top: 20px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Проверка ссылок</h1>
    <button id="start">Начать проверку</button>
    <button id="stop" disabled>Остановить</button>
    <div class="container">
        <div>
            <h2>Все ссылки</h2>
            <div id="results"></div>
        </div>
        <div>
            <h2>Рабочие ссылки</h2>
            <div id="workingLinks"></div>
        </div>
    </div>

    <script>
        // Генерация случайных ссылок (для тестирования 1000 ссылок)
        const generateRandomString = (length) => {
            const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
            let result = "";
            for (let i = 0; i < length; i++) {
                result += chars[Math.floor(Math.random() * chars.length)];
            }
            return result;
        };

        const generateLinks = (count) => {
            const baseURL = "https://kra26.at/storage/image";
            let links = [];
            for (let i = 0; i < count; i++) {
                const firstPart = generateRandomString(2);
                const secondPart = generateRandomString(2);
                const fileName = generateRandomString(16);
                const uuid = `${generateRandomString(8)}-${generateRandomString(4)}-${generateRandomString(4)}-${generateRandomString(4)}-${generateRandomString(12)}`;
                links.push(`${baseURL}/${firstPart}/${secondPart}/${fileName}.webp/${uuid}/`);
            }
            return links;
        };

        const allLinks = generateLinks(1000); // Генерация 1000 случайных ссылок
        let isRunning = false;

        // 1. Проверка с использованием загрузки изображения
        const checkWithImage = (url) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve({ url, status: "working" });
                img.onerror = () => resolve({ url, status: "not-working" });
                img.src = url;
            });
        };

        // 2. Проверка с использованием fetch (HEAD запрос)
        const checkWithFetchHead = async (url) => {
            try {
                const response = await fetch(url, { method: "HEAD" });
                if (response.ok) {
                    return { url, status: "working" };
                } else {
                    return { url, status: "not-working" };
                }
            } catch (error) {
                return { url, status: "not-working" };
            }
        };

        // 3. Проверка с использованием fetch (полный запрос)
        const checkWithFetchFull = async (url) => {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return { url, status: "working" };
                } else {
                    return { url, status: "not-working" };
                }
            } catch (error) {
                return { url, status: "not-working" };
            }
        };

        // 4. Проверка с использованием XMLHttpRequest
        const checkWithXMLHttpRequest = (url) => {
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            resolve({ url, status: "working" });
                        } else {
                            resolve({ url, status: "not-working" });
                        }
                    }
                };
                xhr.onerror = () => resolve({ url, status: "not-working" });
                xhr.send();
            });
        };

        // 5. Проверка с использованием iframe (если ссылка это веб-страница)
        const checkWithIframe = (url) => {
            return new Promise((resolve) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.onload = () => resolve({ url, status: "working" });
                iframe.onerror = () => resolve({ url, status: "not-working" });
                iframe.src = url;
                document.body.appendChild(iframe);
            });
        };

        // Функция для отображения результата
        const display = (res, div) => {
            const el = document.createElement("div");
            el.textContent = res.url;
            el.className = res.status;
            div.appendChild(el);
            div.scrollTop = div.scrollHeight; // прокрутка вниз
        };

        // Функция для запуска проверки всех ссылок
        const startGen = async () => {
            const resultsDiv = document.getElementById("results"), workingDiv = document.getElementById("workingLinks");
            isRunning = true;
            document.getElementById("start").disabled = true;
            document.getElementById("stop").disabled = false;

            for (let link of allLinks) {
                // Пытаемся использовать разные методы для проверки доступности ссылки
                let result = await checkWithImage(link);
                if (result.status === "not-working") result = await checkWithFetchHead(link);
                if (result.status === "not-working") result = await checkWithFetchFull(link);
                if (result.status === "not-working") result = await checkWithXMLHttpRequest(link);
                if (result.status === "not-working") result = await checkWithIframe(link);

                display(result, resultsDiv);
                if (result.status === "working") {
                    display(result, workingDiv);
                }
            }
        };

        // Остановка проверки
        const stopGen = () => {
            isRunning = false;
            document.getElementById("start").disabled = false;
            document.getElementById("stop").disabled = true;
        };

        document.getElementById("start").addEventListener("click", startGen);
        document.getElementById("stop").addEventListener("click", stopGen);
    </script>
</body>
</html>