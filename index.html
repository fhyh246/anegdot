<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авторизация ВКонтакте и загрузка видео</title>
</head>
<body>
    <h1>Авторизация через ВКонтакте и загрузка видео</h1>

    <div>
        <label for="groupIdInput">Введите ID группы:</label>
        <input type="text" id="groupIdInput" placeholder="Пример: 123456789">
        <button onclick="saveGroupId()">Сохранить ID группы</button>
    </div>

    <div style="margin-top: 20px;">
        <button id="authButton" onclick="startAuth()">Авторизоваться через ВКонтакте</button>
    </div>

    <div style="margin-top: 20px;">
        <button id="uploadButton" onclick="uploadVideo()" disabled>Загрузить видео</button>
    </div>

    <div id="status" style="margin-top: 20px; color: red;"></div>

    <div style="margin-top: 20px; padding: 10px; background: #f4f4f4; border: 1px solid #ddd;">
        <h3>Консоль:</h3>
        <pre id="consoleLog" style="max-height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px;"></pre>
    </div>

    <script>
        let groupId = ''; 
        let accessToken = ''; 
        let youtubeApiKey = 'AIzaSyAP6_WnY1mY2f-Wu-bmXucBt3ZKd15xUbE';

        function logToConsole(message) {
            const consoleElement = document.getElementById('consoleLog');
            consoleElement.innerText += message + "\n";
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function saveGroupId() {
            const input = document.getElementById('groupIdInput').value.trim();
            if (input) {
                groupId = input;
                document.getElementById('status').innerText = "ID группы сохранен: " + groupId;
                logToConsole("ID группы сохранен: " + groupId);
            } else {
                document.getElementById('status').innerText = "Введите корректный ID группы.";
                logToConsole("Ошибка: введен некорректный ID группы.");
            }
        }

        function startAuth() {
            logToConsole("Запуск авторизации...");
            accessToken = "vk1.a.gHSaXmdTg09tetrGXSU2Y0vh5LL0m4RIAeCZqypgp_bNkLydy850nopp02JNjjsXuy2B4jKynySRb1klvy-5xsxFfzAqa9CfvG7EjRZEQnDAdm_dBpA0px4Uycg4v1G5KRsjLSOV_rkQ81dysO_j7i6ze_zSstaGAJWceun7_IO4OJwjryZVlHDg3M1WLuI33FrYwEtV47emz7oHxgjjCQ";
            document.getElementById('status').innerText = "Авторизация успешна. Токен получен.";
            logToConsole("Авторизация успешна. Токен получен.");
            document.getElementById('uploadButton').disabled = false;
        }

        async function uploadVideo() {
            logToConsole("Начало загрузки видео...");
            if (!groupId || !accessToken) {
                document.getElementById('status').innerText = "Введите ID группы и авторизуйтесь.";
                logToConsole("Ошибка: не указан ID группы или токен не получен.");
                return;
            }

            try {
                logToConsole("Запрос случайного видео с YouTube...");
                const youtubeResponse = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=тема&maxResults=1&key=${youtubeApiKey}`);
                const youtubeData = await youtubeResponse.json();

                if (!youtubeData.items || youtubeData.items.length === 0) {
                    throw new Error("Не удалось получить видео с YouTube.");
                }

                const randomVideo = youtubeData.items[0];
                const videoTitle = randomVideo.snippet.title;
                const videoDescription = randomVideo.snippet.description;
                const videoUrl = `https://www.youtube.com/watch?v=${randomVideo.id.videoId}`;

                logToConsole(`Видео для загрузки: ${videoTitle}`);

                logToConsole("Запрос ссылки для загрузки видео в ВК...");
                const saveResponse = await fetch(`https://api.vk.com/method/video.save?group_id=${groupId}&name=${encodeURIComponent(videoTitle)}&description=${encodeURIComponent(videoDescription)}&v=5.131&access_token=${accessToken}`);
                const saveData = await saveResponse.json();

                if (saveData.error) {
                    throw new Error("Ошибка VK API: " + saveData.error.error_msg);
                }

                const uploadUrl = saveData.response.upload_url;
                logToConsole("Ссылка для загрузки получена: " + uploadUrl);

                const fileData = await fetch(videoUrl);
                const videoBlob = await fileData.blob();

                logToConsole("Скачивание видео завершено. Начало загрузки на сервер ВКонтакте...");
                const videoData = new FormData();
                videoData.append("video_file", videoBlob, videoTitle);

                const uploadResponse = await fetch(uploadUrl, {
                    method: "POST",
                    body: videoData,
                });

                if (!uploadResponse.ok) {
                    throw new Error("Ошибка загрузки видео.");
                }

                logToConsole("Видео успешно загружено.");
                document.getElementById('status').innerText = "Видео успешно загружено в группу!";
            } catch (error) {
                console.error("Ошибка при загрузке видео:", error);
                document.getElementById('status').innerText = "Ошибка при загрузке видео: " + error.message;
                logToConsole("Ошибка при загрузке видео: " + error.message);
            }
        }
    </script>
</body>
</html>