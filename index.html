<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Сканер QR-Кодов с Камеры</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script> <!-- Для сканирования с фото -->
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 20px;
    }
    #scanner-container {
      width: 100%;
      height: 300px;
      margin-bottom: 20px;
      display: none;
    }
    #results {
      margin-top: 20px;
    }
    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #000;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
  </style>
</head>
<body>

  <h1>Сканер QR-Кодов с Камеры</h1>
  
  <!-- Кнопка для активации камеры и сканирования -->
  <button id="startScanBtn" onclick="startScanner()">Сканировать QR-код</button>
  <button id="takePhotoBtn" onclick="takePhoto()" style="display: none;">Сделать фото</button>
  
  <!-- Контейнер для сканера камеры -->
  <div id="scanner-container"></div>
  
  <h2>Добавить товар</h2>
  <label for="productGroup">Группа:</label>
  <select id="productGroup">
    <option value="нал">Нал</option>
    <option value="безнал">Безнал</option>
  </select><br><br>

  <label for="productName">Название товара:</label>
  <input type="text" id="productName" placeholder="Введите название товара" readonly><br><br>

  <label for="productQuantity">Количество:</label>
  <input type="number" id="productQuantity" placeholder="Введите количество" readonly><br><br>

  <label for="productPrice">Цена:</label>
  <input type="number" id="productPrice" placeholder="Введите цену" readonly><br><br>

  <button onclick="addProduct()">Добавить товар</button>

  <!-- Таблица с товарами -->
  <h2>Список товаров</h2>
  <table id="productsTable">
    <thead>
      <tr>
        <th>Группа</th>
        <th>Название</th>
        <th>Количество</th>
        <th>Цена</th>
      </tr>
    </thead>
    <tbody>
      <!-- Данные товаров будут отображаться здесь -->
    </tbody>
  </table>

  <script>
    let scannerStarted = false;
    const scannerContainer = document.getElementById("scanner-container");
    const startScanBtn = document.getElementById("startScanBtn");
    const takePhotoBtn = document.getElementById("takePhotoBtn");
    const html5QrCode = new Html5Qrcode("scanner-container");

    // Функция для старта сканера
    function startScanner() {
      if (!scannerStarted) {
        scannerStarted = true;
        startScanBtn.innerText = "Остановить сканирование";
        takePhotoBtn.style.display = "block"; // Показываем кнопку "Сделать фото"
        scannerContainer.style.display = "block";

        html5QrCode.start({ facingMode: "environment" }, {
          fps: 10,    // частота кадров
          qrbox: 250  // размер области для сканирования
        }, onScanSuccess).catch((err) => {
          console.log("Ошибка сканирования:", err);
        });
      } else {
        stopScanner();
      }
    }

    // Функция для остановки сканера
    function stopScanner() {
      html5QrCode.stop().then(() => {
        scannerStarted = false;
        startScanBtn.innerText = "Сканировать QR-код";
        takePhotoBtn.style.display = "none"; // Скрываем кнопку "Сделать фото"
        scannerContainer.style.display = "none";
        console.log("Сканер остановлен");
      }).catch((err) => {
        console.log("Ошибка остановки сканера:", err);
      });
    }

    // Функция для обработки успешного сканирования QR-кода
    function onScanSuccess(decodedText, decodedResult) {
      try {
        const productData = JSON.parse(decodedText); // Предполагаем, что QR-код содержит данные в формате JSON
        console.log(productData); // Выводим данные для проверки

        // Заполняем форму на основе данных из QR-кода
        document.getElementById("productName").value = productData.name || "";
        document.getElementById("productQuantity").value = productData.quantity || "";
        document.getElementById("productPrice").value = productData.price || "";

        // Останавливаем сканирование после успешного сканирования
        stopScanner();
      } catch (e) {
        console.error("Ошибка при обработке QR-кода:", e);
      }
    }

    // Функция для захвата изображения с камеры
    function takePhoto() {
      const videoElement = document.querySelector('video');
      const canvas = document.createElement('canvas');
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;
      const context = canvas.getContext('2d');
      context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

      // Теперь сканируем QR-код с этого фото
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      
      if (code) {
        console.log("QR-код найден: ", code.data);
        try {
          const productData = JSON.parse(code.data); // Предполагаем, что QR-код содержит данные в формате JSON
          document.getElementById("productName").value = productData.name || "";
          document.getElementById("productQuantity").value = productData.quantity || "";
          document.getElementById("productPrice").value = productData.price || "";
        } catch (e) {
          console.error("Ошибка при обработке QR-кода:", e);
        }
      } else {
        alert("QR-код не найден.");
      }
    }

    // Функция добавления товара в таблицу
    function addProduct() {
      const name = document.getElementById("productName").value;
      const quantity = document.getElementById("productQuantity").value;
      const price = document.getElementById("productPrice").value;
      const group = document.getElementById("productGroup").value;

      if (name && quantity && price) {
        const table = document.getElementById("productsTable").getElementsByTagName("tbody")[0];
        const row = table.insertRow();

        row.insertCell(0).textContent = group;
        row.insertCell(1).textContent = name;
        row.insertCell(2).textContent = quantity;
        row.insertCell(3).textContent = price;

        // Очистка формы после добавления
        document.getElementById("productName").value = '';
        document.getElementById("productQuantity").value = '';
        document.getElementById("productPrice").value = '';
      } else {
        alert("Пожалуйста, заполните все поля.");
      }
    }
  </script>

</body>
</html>
