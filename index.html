<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Scanner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .device {
      padding: 10px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
    }

    .online {
      background-color: #4CAF50;
      color: white;
    }

    .offline {
      background-color: #f44336;
      color: white;
    }

    .night-mode {
      background-color: #121212;
      color: #ffffff;
    }

    #log {
      margin-top: 20px;
      padding: 10px;
      background-color: #f4f4f4;
      max-height: 200px;
      overflow-y: auto;
    }

    #loading {
      display: none;
    }

    .table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    .table th, .table td {
      padding: 8px 12px;
      border: 1px solid #ddd;
      text-align: left;
    }

    .table th {
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>

  <h1>Network Scanner</h1>

  <button onclick="toggleNightMode()">Toggle Night Mode</button>

  <label for="ip">Enter IP address:</label>
  <input type="text" id="ip" placeholder="192.168.1.1">
  <button onclick="scanNetwork()">Scan IP</button>

  <label for="ipRange">Enter IP range (e.g. 192.168.1.1-192.168.1.255):</label>
  <input type="text" id="ipRange" placeholder="192.168.1.1-192.168.1.255">
  <button onclick="scanRange()">Scan Range</button>

  <div id="loading">Scanning...</div>

  <div id="result"></div>

  <h3>Log:</h3>
  <div id="log"></div>

  <h3>Devices:</h3>
  <table id="deviceTable" class="table">
    <thead>
      <tr>
        <th>IP Address</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function toggleNightMode() {
      document.body.classList.toggle("night-mode");
    }

    function playSound(url) {
      const audio = new Audio(url);
      audio.play();
    }

    function logScan(ip, status) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.innerHTML += `<p>[${timestamp}] Scanned IP: ${ip} - Status: ${status}</p>`;
    }

    function scanNetwork() {
      const ip = document.getElementById('ip').value;
      const resultElement = document.getElementById('result');
      const loadingElement = document.getElementById('loading');

      if (ip === "") {
        resultElement.textContent = "Please enter an IP address.";
        return;
      }

      // Показываем индикатор загрузки
      loadingElement.style.display = "block";
      resultElement.textContent = "";

      fetch(`http://localhost:3000/check_ip?ip=${ip}`, {
        method: 'GET',
      })
        .then(response => response.json())
        .then(data => {
          loadingElement.style.display = "none"; // Скрываем индикатор

          if (data.status === "success") {
            playSound("online.mp3");
            resultElement.textContent = `Device at IP ${ip} is online.`;
            logScan(ip, "online");
          } else {
            playSound("offline.mp3");
            resultElement.textContent = `Device at IP ${ip} is offline.`;
            logScan(ip, "offline");
          }
        })
        .catch(error => {
          loadingElement.style.display = "none"; // Скрываем индикатор
          resultElement.textContent = "Error scanning the network.";
        });
    }

    function scanRange() {
      const range = document.getElementById('ipRange').value;
      const [startIP, endIP] = range.split('-');

      if (!startIP || !endIP) {
        alert("Please enter a valid IP range.");
        return;
      }

      const resultElement = document.getElementById('result');
      const loadingElement = document.getElementById('loading');

      // Показываем индикатор загрузки
      loadingElement.style.display = "block";
      resultElement.textContent = "";

      const startParts = startIP.split('.').map(Number);
      const endParts = endIP.split('.').map(Number);

      let devices = [];
      for (let i = startParts[3]; i <= endParts[3]; i++) {
        const ip = `${startParts[0]}.${startParts[1]}.${startParts[2]}.${i}`;
        fetch(`http://localhost:3000/check_ip?ip=${ip}`, { method: 'GET' })
          .then(response => response.json())
          .then(data => {
            devices.push({ ip, status: data.status === 'success' ? 'online' : 'offline' });

            // Заполняем таблицу
            const table = document.getElementById('deviceTable').getElementsByTagName('tbody')[0];
            const row = table.insertRow();
            const cell1 = row.insertCell(0);
            const cell2 = row.insertCell(1);
            cell1.textContent = ip;
            cell2.textContent = data.status === 'success' ? 'Online' : 'Offline';

            if (devices.length === endParts[3] - startParts[3] + 1) {
              loadingElement.style.display = "none"; // Скрываем индикатор
            }
          })
          .catch(error => {
            console.error("Error scanning range:", error);
            loadingElement.style.display = "none";
          });
      }
    }
  </script>

</body>
</html>