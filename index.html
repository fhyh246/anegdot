<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Загрузка файлов в группу ВКонтакте</title>
    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
</head>
<body>
    <h1>Загрузка файлов в группу ВКонтакте</h1>
    <div id="console" style="background: #f4f4f4; padding: 10px; border: 1px solid #ccc; max-height: 200px; overflow-y: auto;"></div>
    <div>
        <h3>Авторизация</h3>
        <div id="auth-container"></div>
    </div>
    <div>
        <h3>Введите ID группы</h3>
        <input type="text" id="group-id-input" placeholder="Введите ID группы">
    </div>
    <div>
        <h3>Загрузка видео с YouTube</h3>
        <button id="youtube-btn" disabled>Загрузить видео с YouTube</button>
    </div>
    <div>
        <h3>Загрузка своей медиатеки</h3>
        <input type="file" id="file-input" accept="video/*,image/*">
        <button id="upload-btn" disabled>Загрузить файл</button>
    </div>

    <script>
        let accessToken = null;
        let groupId = null;

        const consoleLog = (msg) => {
            const consoleDiv = document.getElementById('console');
            const p = document.createElement('p');
            p.textContent = msg;
            consoleDiv.appendChild(p);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        const enableButtons = () => {
            if (accessToken && groupId) {
                document.getElementById('youtube-btn').disabled = false;
                document.getElementById('upload-btn').disabled = false;
            }
        };

        if ('VKIDSDK' in window) {
            const VKID = window.VKIDSDK;
            VKID.Config.init({
                app: 52966542,
                redirectUrl: 'https://fhyh246.github.io/anegdot/',
                responseMode: VKID.ConfigResponseMode.Callback,
                source: VKID.ConfigSource.LOWCODE,
                scope: 'video,offline,photos',
            });

            const oneTap = new VKID.OneTap();
            oneTap.render({
                container: document.getElementById('auth-container'),
                showAlternativeLogin: true,
            })
            .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, (payload) => {
                VKID.Auth.exchangeCode(payload.code, payload.device_id)
                    .then((data) => {
                        accessToken = data.access_token;
                        consoleLog("Авторизация успешна! Токен получен.");
                        enableButtons();
                    })
                    .catch((error) => consoleLog("Ошибка авторизации: " + error.message));
            })
            .on(VKID.WidgetEvents.ERROR, (error) => consoleLog("Ошибка виджета VKID: " + error.message));
        }

        document.getElementById('group-id-input').addEventListener('input', (e) => {
            groupId = e.target.value.trim();
            if (groupId) consoleLog(`ID группы установлен: ${groupId}`);
            enableButtons();
        });

        document.getElementById('youtube-btn').addEventListener('click', async () => {
            consoleLog("Начало загрузки видео с YouTube...");
            try {
                const youtubeResponse = await fetch(`https://www.googleapis.com/youtube/v3/search?key=YOUR_YOUTUBE_API_KEY&part=snippet&maxResults=1&type=video&videoEmbeddable=true&relevanceLanguage=ru`);
                const youtubeData = await youtubeResponse.json();
                if (!youtubeData.items || !youtubeData.items.length) throw new Error("Видео не найдено.");

                const video = youtubeData.items[0];
                consoleLog(`Видео для загрузки: ${video.snippet.title}`);

                const vkResponse = await fetch(`https://api.vk.com/method/video.save?group_id=${groupId}&name=${video.snippet.title}&description=${video.snippet.description}&access_token=${accessToken}&v=5.131`);
                const vkData = await vkResponse.json();
                if (vkData.error) throw new Error(vkData.error.error_msg);

                const uploadUrl = vkData.response.upload_url;
                consoleLog("Ссылка для загрузки получена.");

                const uploadResponse = await fetch(uploadUrl, { method: 'POST' });
                consoleLog("Видео успешно загружено.");
            } catch (error) {
                consoleLog("Ошибка загрузки видео: " + error.message);
            }
        });

        document.getElementById('upload-btn').addEventListener('click', async () => {
            const file = document.getElementById('file-input').files[0];
            if (!file) {
                consoleLog("Файл не выбран.");
                return;
            }
            consoleLog("Начало загрузки файла...");
            try {
                const vkResponse = await fetch(`https://api.vk.com/method/photos.getWallUploadServer?group_id=${groupId}&access_token=${accessToken}&v=5.131`);
                const vkData = await vkResponse.json();
                if (vkData.error) throw new Error(vkData.error.error_msg);

                const uploadUrl = vkData.response.upload_url;
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch(uploadUrl, { method: 'POST', body: formData });
                const uploadResult = await uploadResponse.json();

                if (uploadResult.error) throw new Error(uploadResult.error.error_msg);

                consoleLog("Файл успешно загружен.");
            } catch (error) {
                consoleLog("Ошибка загрузки файла: " + error.message);
            }
        });
    </script>
</body>
</html>