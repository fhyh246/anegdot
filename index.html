<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авторизация ВКонтакте и загрузка видео</title>
</head>
<body>
    <h1>Авторизация через ВКонтакте и загрузка видео</h1>

    <!-- Поле для ввода ID группы -->
    <div>
        <label for="groupIdInput">Введите ID группы:</label>
        <input type="text" id="groupIdInput" placeholder="Пример: 123456789">
        <button onclick="saveGroupId()">Сохранить ID группы</button>
    </div>

    <!-- Кнопка авторизации -->
    <div style="margin-top: 20px;">
        <button id="authButton" onclick="startAuth()">Авторизоваться через ВКонтакте</button>
    </div>

    <!-- Кнопка для загрузки видео -->
    <div style="margin-top: 20px;">
        <button id="uploadButton" onclick="uploadVideo()" disabled>Загрузить видео</button>
    </div>

    <!-- Поле для отображения статуса -->
    <div id="status" style="margin-top: 20px; color: red;"></div>

    <!-- Консоль для логирования -->
    <div style="margin-top: 20px; padding: 10px; background: #f4f4f4; border: 1px solid #ddd;">
        <h3>Консоль:</h3>
        <pre id="consoleLog" style="max-height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px;"></pre>
    </div>

    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
    <script type="text/javascript">
        if ('VKIDSDK' in window) {
            const VKID = window.VKIDSDK;
            let groupId = ''; // ID группы
            let accessToken = ''; // Токен пользователя

            // Функция для вывода в консоль
            function logToConsole(message) {
                const consoleElement = document.getElementById('consoleLog');
                consoleElement.innerText += message + "\n";
                consoleElement.scrollTop = consoleElement.scrollHeight; // Прокрутка вниз
            }

            // Инициализация VKID SDK
            VKID.Config.init({
                app: 52966542, // ID приложения
                redirectUrl: 'https://fhyh246.github.io/anegdot/', // URL редиректа
                responseMode: VKID.ConfigResponseMode.Callback,
                source: VKID.ConfigSource.LOWCODE,
                scope: 'video,groups,offline', // Запрашиваемые доступы
            });

            // Сохранение ID группы
            function saveGroupId() {
                const input = document.getElementById('groupIdInput').value.trim();
                if (input) {
                    groupId = input;
                    document.getElementById('status').innerText = "ID группы сохранен: " + groupId;
                    logToConsole("ID группы сохранен: " + groupId);
                } else {
                    document.getElementById('status').innerText = "Введите корректный ID группы.";
                    logToConsole("Ошибка: введен некорректный ID группы.");
                }
            }

            // Запуск авторизации
            function startAuth() {
                logToConsole("Запуск авторизации...");
                const floatingOneTap = new VKID.FloatingOneTap();

                floatingOneTap.render({
                    appName: 'YouTube Premium',
                    showAlternativeLogin: true
                })
                .on(VKID.WidgetEvents.ERROR, vkidOnError)
                .on(VKID.FloatingOneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                    const code = payload.code;
                    const deviceId = payload.device_id;

                    VKID.Auth.exchangeCode(code, deviceId)
                        .then(vkidOnSuccess)
                        .catch(vkidOnError);
                });
            }

            // Успешная авторизация
            function vkidOnSuccess(data) {
                console.log("Успешная авторизация:", data);
                accessToken = data.access_token;
                document.getElementById('status').innerText = "Авторизация успешна. Токен получен.";
                logToConsole("Авторизация успешна. Токен получен.");
                document.getElementById('uploadButton').disabled = false; // Разблокировать кнопку загрузки видео
            }

            // Обработка ошибок авторизации
            function vkidOnError(error) {
                console.error("Ошибка авторизации:", error);
                document.getElementById('status').innerText = "Ошибка авторизации. Проверьте настройки.";
                logToConsole("Ошибка авторизации: " + error.message);
            }

            // Функция загрузки видео
            async function uploadVideo() {
                logToConsole("Начало загрузки видео...");
                if (!groupId || !accessToken) {
                    document.getElementById('status').innerText = "Введите ID группы и авторизуйтесь.";
                    logToConsole("Ошибка: не указан ID группы или токен не получен.");
                    return;
                }

                try {
                    // 1. Получить ссылку для загрузки
                    logToConsole("Запрос ссылки для загрузки видео...");
                    const saveResponse = await fetch(`https://api.vk.com/method/video.save?group_id=${groupId}&name=Название+видео&description=Описание+видео&v=5.131&access_token=${accessToken}`);
                    const saveData = await saveResponse.json();

                    if (saveData.error) {
                        throw new Error("Ошибка VK API: " + saveData.error.error_msg);
                    }

                    const uploadUrl = saveData.response.upload_url;
                    logToConsole("Ссылка для загрузки получена: " + uploadUrl);

                    // 2. Загрузить видео по полученной ссылке
                    logToConsole("Начало загрузки видео на сервер ВКонтакте...");
                    const videoData = new FormData();
                    videoData.append("video_file", new Blob(["Ваш файл видео"])); // Замените на настоящий файл

                    const uploadResponse = await fetch(uploadUrl, {
                        method: "POST",
                        body: videoData,
                    });

                    if (!uploadResponse.ok) {
                        throw new Error("Ошибка загрузки видео.");
                    }

                    logToConsole("Видео успешно загружено.");
                    document.getElementById('status').innerText = "Видео успешно загружено в группу!";
                } catch (error) {
                    console.error("Ошибка при загрузке видео в VK:", error);
                    document.getElementById('status').innerText = "Ошибка при загрузке видео: " + error.message;
                    logToConsole("Ошибка при загрузке видео: " + error.message);
                }
            }
        }
    </script>
</body>
</html>