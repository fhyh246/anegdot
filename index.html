<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VK Загрузка медиа</title>
</head>
<body>
    <h1>Загрузка видео и фото в группу ВК</h1>

    <!-- VK ID Widgets -->
    <div>
        <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
        <script type="text/javascript">
            if ('VKIDSDK' in window) {
                const VKID = window.VKIDSDK;

                VKID.Config.init({
                    app: 52966695,
                    redirectUrl: 'https://fhyh246.github.io/anegdot/',
                    responseMode: VKID.ConfigResponseMode.Callback,
                    source: VKID.ConfigSource.LOWCODE,
                    scope: 'photos,video,groups', // Права для загрузки фото, видео и работы с группами
                });

                // OneTap Authorization
                const oneTap = new VKID.OneTap();
                oneTap.render({
                    container: document.currentScript.parentElement,
                    showAlternativeLogin: true,
                }).on(VKID.WidgetEvents.ERROR, vkidOnError)
                  .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, vkidOnSuccess);

                // Floating Authorization
                const floatingOneTap = new VKID.FloatingOneTap();
                floatingOneTap.render({
                    appName: 'Fight',
                    showAlternativeLogin: true,
                }).on(VKID.WidgetEvents.ERROR, vkidOnError)
                  .on(VKID.FloatingOneTapInternalEvents.LOGIN_SUCCESS, vkidOnSuccess);

                // OAuth Authorization
                const oAuth = new VKID.OAuthList();
                oAuth.render({
                    container: document.currentScript.parentElement,
                    oauthList: ['vkid'],
                }).on(VKID.WidgetEvents.ERROR, vkidOnError)
                  .on(VKID.OAuthListInternalEvents.LOGIN_SUCCESS, vkidOnSuccess);

                function vkidOnSuccess(data) {
                    VK_ACCESS_TOKEN = data.access_token;
                    logToConsole('Авторизация через VKID успешна. Токен получен.');
                }

                function vkidOnError(error) {
                    logToConsole('Ошибка авторизации через VKID: ' + error.message);
                }
            }
        </script>
    </div>

    <!-- Загрузка медиа -->
    <label for="group-id">Введите ID группы:</label>
    <input type="text" id="group-id" placeholder="ID вашей группы">
    <br><br>

    <button id="youtube-btn">Загрузить случайное видео с YouTube</button>
    <button id="upload-photo-btn">Загрузить собственную фотографию</button>
    <button id="upload-video-btn">Загрузить собственное видео</button>

    <input type="file" id="file-input" style="display: none;">

    <p id="console">Консоль:</p>

    <script>
        const YOUTUBE_API_KEY = "AIzaSyAP6_WnY1mY2f-Wu-bmXucBt3ZKd15xUbE";
        let VK_ACCESS_TOKEN = null;
        let groupId;

        function logToConsole(message) {
            const consoleElement = document.getElementById('console');
            consoleElement.innerHTML += `<br>${message}`;
        }

        // Сохранение ID группы
        document.getElementById('group-id').addEventListener('change', function (e) {
            groupId = e.target.value;
            logToConsole(`ID группы установлен: ${groupId}`);
        });

        // Загрузка случайного видео с YouTube
        document.getElementById('youtube-btn').addEventListener('click', async function () {
            if (!groupId || !VK_ACCESS_TOKEN) {
                logToConsole("Ошибка: Укажите ID группы и авторизуйтесь.");
                return;
            }

            logToConsole("Запрос случайного видео с YouTube...");
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&type=video&videoEmbeddable=true&videoCaption=any&key=${YOUTUBE_API_KEY}`);
                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    const videoId = data.items[0].id.videoId;
                    const videoTitle = data.items[0].snippet.title;
                    logToConsole(`Видео для загрузки: ${videoTitle} (${videoId})`);

                    const vkResponse = await fetch(`https://api.vk.com/method/video.save?group_id=${groupId}&name=${encodeURIComponent(videoTitle)}&v=5.131&access_token=${VK_ACCESS_TOKEN}`);
                    const vkData = await vkResponse.json();

                    if (vkData.response) {
                        const uploadUrl = vkData.response.upload_url;
                        logToConsole(`Ссылка для загрузки получена. Загрузка видео...`);
                        await fetch(uploadUrl, { method: 'POST' });
                        logToConsole("Видео успешно загружено в группу.");
                    } else {
                        throw new Error(vkData.error.error_msg || "Неизвестная ошибка");
                    }
                } else {
                    throw new Error("Видео не найдено.");
                }
            } catch (error) {
                logToConsole(`Ошибка при загрузке видео: ${error.message}`);
            }
        });

        // Загрузка собственных файлов
        document.getElementById('upload-photo-btn').addEventListener('click', function () {
            document.getElementById('file-input').accept = "image/*";
            document.getElementById('file-input').click();
        });

        document.getElementById('upload-video-btn').addEventListener('click', function () {
            document.getElementById('file-input').accept = "video/*";
            document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file || !groupId || !VK_ACCESS_TOKEN) {
                logToConsole("Ошибка: Укажите ID группы, авторизуйтесь и выберите файл.");
                return;
            }

            logToConsole(`Загрузка файла: ${file.name}`);
            try {
                const endpoint = file.type.startsWith("image") ? "photos.getUploadServer" : "video.save";
                const vkResponse = await fetch(`https://api.vk.com/method/${endpoint}?group_id=${groupId}&v=5.131&access_token=${VK_ACCESS_TOKEN}`);
                const vkData = await vkResponse.json();

                if (vkData.response && vkData.response.upload_url) {
                    const uploadUrl = vkData.response.upload_url;
                    const formData = new FormData();
                    formData.append('file1', file);

                    const uploadResponse = await fetch(uploadUrl, { method: 'POST', body: formData });
                    logToConsole("Файл успешно загружен.");
                } else {
                    throw new Error(vkData.error.error_msg || "Неизвестная ошибка");
                }
            } catch (error) {
                logToConsole(`Ошибка при загрузке файла: ${error.message}`);
            }
        });
    </script>
</body>
</html>