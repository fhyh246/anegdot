<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка ссылок</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .working { color: green; }
        .not-working { color: red; }
        #results, #workingLinks {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
        }
        .container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
        }
        h2 {
            text-align: center;
        }
        button {
            margin-top: 20px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled {
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Проверка ссылок</h1>
    <button id="start">Начать проверку</button>
    <button id="stop" disabled>Остановить</button>
    <div class="container">
        <div>
            <h2>Все ссылки</h2>
            <div id="results"></div>
        </div>
        <div>
            <h2>Рабочие ссылки</h2>
            <div id="workingLinks"></div>
        </div>
    </div>

    <script>
        const predefinedLinks = [
            "https://kra26.at/storage/image/1w/eb/s8wmmp62lisuoinp.webp/25edd29c-49c2-49ff-a406-cd8754b3e01d/",
            "https://kra26.at/storage/image/3t/ll/8yqkxw33znid6k3x.webp/4e894cb2-44c7-4889-a92b-0b56cdcb3e29/",
            "https://kra26.at/storage/image/lo/qk/rzc5f8ddnpkgruf4.webp/4c4e2ce8-246a-4c1b-b1c7-7a6999326b36/"
        ];

        const generateRandomString = (length) => {
            const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
            let result = "";
            for (let i = 0; i < length; i++) {
                result += chars[Math.floor(Math.random() * chars.length)];
            }
            return result;
        };

        const generateLinks = (count) => {
            const baseURL = "https://kra26.at/storage/image";
            let links = [];
            for (let i = 0; i < count; i++) {
                const firstPart = generateRandomString(2);
                const secondPart = generateRandomString(2);
                const fileName = generateRandomString(16);
                const uuid = `${generateRandomString(8)}-${generateRandomString(4)}-${generateRandomString(4)}-${generateRandomString(4)}-${generateRandomString(12)}`;
                links.push(`${baseURL}/${firstPart}/${secondPart}/${fileName}.webp/${uuid}/`);
            }
            return links;
        };

        const allLinks = predefinedLinks.concat(generateLinks(1000));

        let isRunning = false;

        // Проверка через fetch и проверка типа контента
        const checkWithFetch = async (url) => {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                // Проверка типа контента
                const contentType = response.headers.get("Content-Type");
                if (response.status !== 404 && contentType && contentType.includes("image")) {
                    return { url, status: "working" };
                } else {
                    return { url, status: "not-working" };
                }
            } catch (error) {
                return { url, status: "not-working" };
            }
        };

        // Проверка через загрузку изображения
        const checkImageLoad = async (url) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve({ url, status: "working" });
                img.onerror = () => resolve({ url, status: "not-working" });
                img.src = url;
            });
        };

        const display = (res, div) => {
            const el = document.createElement("div");
            el.textContent = res.url;
            el.className = res.status;
            div.appendChild(el);
            div.scrollTop = div.scrollHeight;
        };

        const startGen = async () => {
            const resultsDiv = document.getElementById("results"), workingDiv = document.getElementById("workingLinks");
            isRunning = true;
            document.getElementById("start").disabled = true;
            document.getElementById("stop").disabled = false;

            for (let link of allLinks) {
                if (!isRunning) break;

                // Сначала пробуем проверку с fetch
                let result = await checkWithFetch(link);
                if (result.status === "not-working") {
                    // Если fetch не сработал, пробуем загрузить изображение
                    result = await checkImageLoad(link);
                }

                display(result, resultsDiv);
                if (result.status === "working") {
                    display(result, workingDiv);
                }
            }
        };

        const stopGen = () => {
            isRunning = false;
            document.getElementById("start").disabled = false;
            document.getElementById("stop").disabled = true;
        };

        document.getElementById("start").addEventListener("click", startGen);
        document.getElementById("stop").addEventListener("click", stopGen);
    </script>
</body>
</html>