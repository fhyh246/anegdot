<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Загрузка файлов в группу ВКонтакте</title>
    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
</head>
<body>
    <h1>Загрузка файлов в группу ВКонтакте</h1>
    <div>
        <h3>Авторизация</h3>
        <div id="auth-container"></div>
        <p id="auth-status">Не авторизовано</p>
    </div>
    <div>
        <h3>Введите ID группы</h3>
        <input type="text" id="group-id-input" placeholder="Введите ID группы">
        <p id="group-status">Группа не выбрана</p>
    </div>
    <div>
        <h3>Загрузить файл</h3>
        <input type="file" id="file-input" accept="video/*,image/*">
        <button id="upload-btn" disabled>Загрузить</button>
        <p id="upload-status"></p>
    </div>

    <script>
        let accessToken = null; // Токен доступа
        let groupId = null; // ID группы
        const authStatus = document.getElementById('auth-status');
        const groupStatus = document.getElementById('group-status');
        const uploadStatus = document.getElementById('upload-status');
        const groupIdInput = document.getElementById('group-id-input');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');

        // Инициализация VKID SDK
        if ('VKIDSDK' in window) {
            const VKID = window.VKIDSDK;
            VKID.Config.init({
                app: 52966542,
                redirectUrl: 'https://fhyh246.github.io/anegdot/',
                responseMode: VKID.ConfigResponseMode.Callback,
                source: VKID.ConfigSource.LOWCODE,
                scope: 'video,offline,photos',
            });

            const oneTap = new VKID.OneTap();
            oneTap.render({
                container: document.getElementById('auth-container'),
                showAlternativeLogin: true,
            })
            .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                const code = payload.code;
                const deviceId = payload.device_id;

                VKID.Auth.exchangeCode(code, deviceId)
                    .then((data) => {
                        accessToken = data.access_token;
                        authStatus.innerText = "Авторизация успешна!";
                        console.log("Токен доступа получен:", accessToken);
                        enableUploadButton();
                    })
                    .catch((error) => {
                        authStatus.innerText = "Ошибка авторизации.";
                        console.error("Ошибка авторизации:", error);
                    });
            })
            .on(VKID.WidgetEvents.ERROR, (error) => {
                authStatus.innerText = "Ошибка виджета.";
                console.error("Ошибка виджета VKID:", error);
            });
        }

        // Включение кнопки загрузки при наличии токена и ID группы
        function enableUploadButton() {
            if (accessToken && groupId) {
                uploadBtn.disabled = false;
            }
        }

        // Обработка ввода ID группы
        groupIdInput.addEventListener('input', () => {
            groupId = groupIdInput.value.trim();
            if (groupId) {
                groupStatus.innerText = `ID группы сохранен: ${groupId}`;
                enableUploadButton();
            } else {
                groupStatus.innerText = "Группа не выбрана";
                uploadBtn.disabled = true;
            }
        });

        // Обработка загрузки файла
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                uploadStatus.innerText = "Выберите файл для загрузки.";
                return;
            }

            uploadStatus.innerText = "Начало загрузки файла...";
            try {
                // Получение ссылки для загрузки
                const uploadUrlResponse = await fetch(
                    `https://api.vk.com/method/video.save?group_id=${groupId}&name=${file.name}&description=Загружено через приложение&access_token=${accessToken}&v=5.131`
                );
                const uploadUrlData = await uploadUrlResponse.json();

                if (uploadUrlData.error) {
                    throw new Error(`Ошибка VK API: ${uploadUrlData.error.error_msg}`);
                }

                const uploadUrl = uploadUrlData.response.upload_url;

                // Загрузка файла
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData,
                });

                const uploadResult = await uploadResponse.json();
                if (uploadResult.error) {
                    throw new Error(`Ошибка загрузки: ${uploadResult.error.error_msg}`);
                }

                uploadStatus.innerText = "Файл успешно загружен!";
                console.log("Результат загрузки:", uploadResult);
            } catch (error) {
                uploadStatus.innerText = `Ошибка загрузки: ${error.message}`;
                console.error("Ошибка при загрузке файла:", error);
            }
        });
    </script>
</body>
</html>